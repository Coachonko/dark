{"version":3,"file":"125.build.js","mappings":"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","sources":["webpack:///./components/product-list.tsx","webpack:///./api/index.ts","webpack:///../../../packages/core/src/use-resource/use-resource.ts","webpack:///../../../packages/core/src/use-mutation/use-mutation.ts","webpack:///./hooks/index.ts","webpack:///../../../packages/web-router/src/use-match/use-match.ts"],"sourcesContent":["import { type DarkElement, h, component } from '@dark-engine/core';\r\nimport { RouterLink, useMatch, useLocation } from '@dark-engine/web-router';\r\nimport { styled } from '@dark-engine/styled';\r\n\r\nimport { useProducts } from '../hooks';\r\nimport { Spinner, Error, AnimationFade, Button, List, ListItem } from './ui';\r\n\r\nconst Header = styled.header`\r\n  display: grid;\r\n  grid-template-columns: 1fr 4fr;\r\n  grid-template-rows: auto;\r\n  padding: 16px 0;\r\n\r\n  & h2 {\r\n    margin: 0;\r\n  }\r\n`;\r\n\r\nconst ProductList = component<{ slot: DarkElement }>(({ slot }) => {\r\n  const { url } = useMatch();\r\n  const { pathname } = useLocation();\r\n  const { data, loading, error } = useProducts();\r\n  const isList = pathname.endsWith('list/');\r\n  const urlToAdd = url + 'add/';\r\n  const renderList = () => {\r\n    return (\r\n      <List>\r\n        {[...data].reverse().map(x => {\r\n          return (\r\n            <ListItem key={x.id}>\r\n              <RouterLink to={`${url}${x.id}`}>{x.name}</RouterLink>\r\n            </ListItem>\r\n          );\r\n        })}\r\n      </List>\r\n    );\r\n  };\r\n\r\n  if (loading) return <Spinner />;\r\n  if (error) return <Error value={error} />;\r\n\r\n  return (\r\n    <AnimationFade>\r\n      <Header>\r\n        <div>\r\n          {isList ? (\r\n            <Button as={RouterLink} to={urlToAdd}>\r\n              Add product\r\n            </Button>\r\n          ) : (\r\n            <Button onClick={() => history.back()}>Back</Button>\r\n          )}\r\n        </div>\r\n      </Header>\r\n      <AnimationFade key={pathname}>{slot || renderList()}</AnimationFade>\r\n    </AnimationFade>\r\n  );\r\n});\r\n\r\nexport default ProductList;\r\n","export type ProductBrief = {\r\n  id: number;\r\n  name: string;\r\n};\r\n\r\nexport type Product = {\r\n  id: number;\r\n  name: string;\r\n  description: string;\r\n};\r\n\r\nexport enum Cache {\r\n  PRODUCTS = 'products',\r\n  PRODUCT_ITEM = 'product-item',\r\n}\r\n\r\nconst IS_SERVER = typeof globalThis.window === 'undefined';\r\nconst TIMEOUT = IS_SERVER ? 100 : 600;\r\n\r\nconst sleep = (ms: number) => new Promise(resolve => setTimeout(resolve, ms));\r\n\r\n// sumulates the database\r\nlet nextId = 0;\r\nconst products: Array<Product> = new Array(50).fill(null).map(() => ({\r\n  id: ++nextId,\r\n  name: `Product #${nextId}`,\r\n  description:\r\n    'Lorem ipsum dolor sit amet consectetur, adipisicing elit. Nostrum blanditiis quia minus corrupti quidem. Ipsam quae ad velit repudiandae molestias unde'.repeat(\r\n      3,\r\n    ),\r\n}));\r\n\r\n// api\r\nconst api = {\r\n  async fetchProducts() {\r\n    await sleep(TIMEOUT);\r\n    const briefs = products.map(x => ({ ...x, description: null })) as Array<ProductBrief>;\r\n\r\n    return briefs;\r\n  },\r\n  async fetchProduct(id: number) {\r\n    if (!detectIsValidId(id)) throwError();\r\n    await sleep(TIMEOUT);\r\n    const product = products.find(x => x.id === id) || null;\r\n\r\n    return product;\r\n  },\r\n  async addProduct(product: Partial<Product>) {\r\n    if (detectIsValidId(product.id)) throwError();\r\n    await sleep(TIMEOUT);\r\n\r\n    product.id = ++nextId;\r\n    products.push(product as Product);\r\n\r\n    return product as Product;\r\n  },\r\n  async changeProduct(product: Product) {\r\n    if (!detectIsValidId(product.id)) throwError();\r\n    if (!product) return null;\r\n    await sleep(TIMEOUT);\r\n    const idx = products.findIndex(x => x.id === product.id);\r\n\r\n    if (idx !== -1) {\r\n      products.splice(idx, 1, product);\r\n    }\r\n\r\n    return product;\r\n  },\r\n  async removeProduct(id: number) {\r\n    if (!detectIsValidId(id)) throwError();\r\n    await sleep(TIMEOUT);\r\n    const idx = products.findIndex(x => x.id === id);\r\n\r\n    if (idx !== -1) {\r\n      products.splice(idx, 1);\r\n    }\r\n\r\n    return true;\r\n  },\r\n};\r\n\r\nconst detectIsValidId = (id: unknown) => typeof id === 'number' && !Number.isNaN(id);\r\n\r\nconst throwError = () => {\r\n  throw new Error('Invalid id!');\r\n};\r\n\r\nexport { api };\r\n","import { type InMemoryCache, useCache, CACHE_ROOT_ID } from '../cache';\r\nimport { type AppResource, type Callback, type TextBased } from '../shared';\r\nimport { error, detectIsFunction, mapRecord } from '../utils';\r\nimport { useLayoutEffect } from '../use-layout-effect';\r\nimport { detectIsServer } from '../platform';\r\nimport { useEffect } from '../use-effect';\r\nimport { useSuspense } from '../suspense';\r\nimport { useUpdate } from '../use-update';\r\nimport { useMemo } from '../use-memo';\r\nimport { $$scope } from '../scope';\r\n\r\ntype UseResourceOptions<V extends Variables> = {\r\n  variables?: V;\r\n  key?: string;\r\n  extractId?: (x: V) => TextBased;\r\n  onBefore?: () => void;\r\n};\r\n\r\nfunction useResource<T, V extends Variables>(query: Query<T, V>, options?: UseResourceOptions<V>) {\r\n  const {\r\n    variables = {} as V,\r\n    key: cacheKey,\r\n    extractId = () => CACHE_ROOT_ID,\r\n    onBefore,\r\n  } = options || { variables: {} as V };\r\n  const $scope = $$scope();\r\n  const cache = useCache();\r\n  const cacheId = extractId(variables);\r\n  const id = useMemo(() => $scope.getNextResourceId(), []);\r\n  const state = useMemo<State<T>>(() => createState<T>(cache, cacheKey, cacheId), []);\r\n  const { register, unregister } = useSuspense();\r\n  const [mounted, firstTime] = useMounted();\r\n  const update = useUpdate();\r\n  const $update = () => mounted() && update();\r\n  const isServer = detectIsServer();\r\n  const isHydrateZone = $scope.getIsHydrateZone();\r\n  const { isLoaded } = state;\r\n\r\n  state.cacheKey = cacheKey;\r\n  state.cacheId = cacheId;\r\n\r\n  const make = async (isRefetch?: boolean, $variables?: V) => {\r\n    const $$variables = isRefetch ? $variables : variables;\r\n    const $cacheId = extractId($$variables);\r\n\r\n    detectIsFunction(onBefore) && onBefore();\r\n\r\n    try {\r\n      if (!isServer && !firstTime()) {\r\n        state.isFetching = true;\r\n        $update();\r\n      }\r\n      const data = await query($$variables);\r\n\r\n      if (isServer) {\r\n        $scope.setResource(id, [data, null]);\r\n      } else {\r\n        unregister(id);\r\n        state.data = data;\r\n        state.isFetching = false;\r\n        state.error = null;\r\n      }\r\n\r\n      if (cacheKey && cache && data) {\r\n        cache.write({ key: cacheKey, id: $cacheId, data });\r\n      }\r\n\r\n      return data;\r\n    } catch (err) {\r\n      error(err);\r\n\r\n      if (isServer) {\r\n        $scope.setResource(id, [null, String(err)]);\r\n      } else {\r\n        unregister(id);\r\n        state.isFetching = false;\r\n        state.error = String(err);\r\n      }\r\n    } finally {\r\n      if (!isServer) {\r\n        state.isLoaded = true;\r\n        $update();\r\n      }\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    if (isHydrateZone) return;\r\n    if (cacheKey && cache) {\r\n      const record = cache.read({ key: cacheKey, id: cacheId });\r\n\r\n      if (record?.valid) return;\r\n    }\r\n\r\n    make();\r\n  }, [...mapRecord(variables)]);\r\n\r\n  useEffect(() => {\r\n    let off: Callback = null;\r\n\r\n    if (cache) {\r\n      off = cache.subscribe(({ type, key, id }) => {\r\n        if (key === state.cacheKey && id === state.cacheId) {\r\n          if (type === 'invalidate' || type === 'optimistic') {\r\n            if (cache.canUpdate(key)) {\r\n              make();\r\n            }\r\n          }\r\n        }\r\n      });\r\n    }\r\n\r\n    return () => {\r\n      unregister(id);\r\n      detectIsFunction(off) && off();\r\n    };\r\n  }, []);\r\n\r\n  if (isServer || isHydrateZone) {\r\n    const res = $scope.getResource(id) as AppResource<T>;\r\n\r\n    if (isServer) {\r\n      if (res) {\r\n        mutate(state, res);\r\n      } else {\r\n        $scope.defer(make);\r\n      }\r\n    } else if (isHydrateZone) {\r\n      if (!res) throw new Error('[Dark]: can not read app state from the server!');\r\n      const [data] = res;\r\n\r\n      mutate(state, res);\r\n\r\n      if (cacheKey && cache && data) {\r\n        cache.write({ key: cacheKey, id: cacheId, data });\r\n      }\r\n    }\r\n  } else {\r\n    firstTime() && !isLoaded && register(id);\r\n  }\r\n\r\n  const result: Result<T> = {\r\n    loading: state.isFetching,\r\n    data: state.data,\r\n    error: state.error,\r\n    refetch: (variables: V) => make(true, variables),\r\n  };\r\n\r\n  return result;\r\n}\r\n\r\nfunction createState<T>(cache: InMemoryCache, cacheKey: string, cacheId: TextBased) {\r\n  const state: State<T> = {\r\n    isFetching: true,\r\n    isLoaded: false,\r\n    data: null,\r\n    error: null,\r\n    cacheKey,\r\n    cacheId,\r\n  };\r\n\r\n  if (cache) {\r\n    const record = cache.read({ key: cacheKey, id: cacheId });\r\n\r\n    if (record) {\r\n      state.isFetching = false;\r\n      state.isLoaded = true;\r\n      state.data = record.data as T;\r\n    }\r\n  }\r\n\r\n  return state;\r\n}\r\n\r\nfunction mutate<T>(state: State<T>, res: AppResource<T>) {\r\n  const [data, error] = res;\r\n\r\n  state.isFetching = false;\r\n  state.isLoaded = true;\r\n  state.data = data;\r\n  state.error = error;\r\n}\r\n\r\nfunction useMounted() {\r\n  const scope = useMemo(() => ({ isMounted: true, isFirstTime: true }), []);\r\n  const { isFirstTime } = scope;\r\n\r\n  useLayoutEffect(() => {\r\n    scope.isFirstTime = false;\r\n    return () => (scope.isMounted = false);\r\n  }, []);\r\n\r\n  return [() => scope.isMounted, () => isFirstTime] as [BooleanFn, BooleanFn];\r\n}\r\n\r\ntype BooleanFn = () => boolean;\r\n\r\ntype State<T> = {\r\n  isFetching: boolean;\r\n  isLoaded: boolean;\r\n  data: T;\r\n  error: string;\r\n  cacheId: TextBased;\r\n  cacheKey: string;\r\n};\r\n\r\ntype Result<T> = {\r\n  loading: boolean;\r\n  data: T;\r\n  error: string;\r\n  refetch: Query<T>;\r\n};\r\n\r\ntype Variables<K extends string = string, V = any> = Record<K, V>;\r\n\r\ntype Query<T, V extends Variables = Variables> = (variables: V) => Promise<T>;\r\n\r\nexport { useResource };\r\n","import { error, detectIsFunction } from '../utils';\r\nimport { useUpdate } from '../use-update';\r\nimport { useMemo } from '../use-memo';\r\nimport { type InMemoryCache, useCache } from '../cache';\r\n\r\ntype UseMutatinOptions<T> = {\r\n  refetchQueries?: Array<string>;\r\n  onSuccess?: (x: InMemoryCache, data: T) => void;\r\n};\r\n\r\nfunction useMutation<M extends Mutation>(mutation: M, options?: UseMutatinOptions<Awaited<ReturnType<M>>>) {\r\n  type Params = Parameters<M>;\r\n  type AwaitedResult = Awaited<ReturnType<M>>;\r\n  const { refetchQueries = [], onSuccess } = options || {};\r\n  const update = useUpdate();\r\n  const cache = useCache();\r\n  const state = useMemo<State<AwaitedResult>>(() => ({ isFetching: false, data: null, error: null }), []);\r\n  const make = async (...args: Params) => {\r\n    let data: AwaitedResult = null;\r\n\r\n    try {\r\n      state.isFetching = true;\r\n      state.error = null;\r\n      update();\r\n      data = (await mutation(...args)) as AwaitedResult;\r\n      detectIsFunction(onSuccess) && onSuccess(cache, data);\r\n      refetchQueries.forEach(x => cache.invalidate({ key: x }));\r\n    } catch (err) {\r\n      error(err);\r\n      state.error = String(err);\r\n    } finally {\r\n      state.isFetching = false;\r\n      update();\r\n    }\r\n\r\n    return data;\r\n  };\r\n  const result: Result<AwaitedResult> = {\r\n    loading: state.isFetching,\r\n    data: state.data,\r\n    error: state.error,\r\n  };\r\n\r\n  return [make, result] as [(...args: Params) => ReturnType<M>, Result<AwaitedResult>];\r\n}\r\n\r\ntype State<T> = {\r\n  isFetching: boolean;\r\n  data: T;\r\n  error: string;\r\n};\r\n\r\ntype Result<T> = {\r\n  loading: boolean;\r\n} & Pick<State<T>, 'data' | 'error'>;\r\n\r\ntype Mutation = (...args: Array<unknown>) => Promise<unknown>;\r\n\r\nexport { useMutation };\r\n","import { useResource, useMutation } from '@dark-engine/core';\r\n\r\nimport { type ProductBrief, Cache, api } from '../api';\r\n\r\nfunction useProducts() {\r\n  return useResource(() => api.fetchProducts(), {\r\n    key: Cache.PRODUCTS,\r\n    onBefore: () => console.log('[fetch]: products'),\r\n  });\r\n}\r\n\r\nfunction useProduct(id: number) {\r\n  return useResource(({ id }) => api.fetchProduct(id), {\r\n    variables: { id },\r\n    key: Cache.PRODUCT_ITEM,\r\n    extractId: x => x.id,\r\n    onBefore: () => {\r\n      console.log('[fetch]: product', id);\r\n    },\r\n  });\r\n}\r\n\r\nfunction useAddProductMutation() {\r\n  return useMutation(api.addProduct, {\r\n    onSuccess: (cache, product) => {\r\n      const record = cache.read<Array<ProductBrief>>({ key: Cache.PRODUCTS });\r\n\r\n      if (record) {\r\n        const products = record.data;\r\n\r\n        products.push(product);\r\n        cache.optimistic({ key: Cache.PRODUCTS, data: products });\r\n      }\r\n    },\r\n  });\r\n}\r\n\r\nfunction useChangeProductMutation() {\r\n  return useMutation(api.changeProduct, {\r\n    onSuccess: (cache, product) => {\r\n      const record = cache.read<Array<ProductBrief>>({ key: Cache.PRODUCTS });\r\n\r\n      if (record) {\r\n        const products = record.data;\r\n        const $product = products.find(x => x.id === product.id);\r\n\r\n        $product.name = product.name;\r\n        cache.optimistic({ key: Cache.PRODUCTS, data: products });\r\n        cache.optimistic({ key: Cache.PRODUCT_ITEM, data: product, id: product.id });\r\n      }\r\n    },\r\n  });\r\n}\r\n\r\nfunction useRemoveProductMutation(id: number) {\r\n  return useMutation(() => api.removeProduct(id), {\r\n    onSuccess: cache => {\r\n      const record = cache.read<Array<ProductBrief>>({ key: Cache.PRODUCTS });\r\n\r\n      if (record) {\r\n        const products = record.data;\r\n        const idx = products.findIndex(x => x.id === id);\r\n\r\n        if (idx !== -1) {\r\n          products.splice(idx, 1);\r\n          cache.optimistic({ key: Cache.PRODUCTS, data: products });\r\n        }\r\n      }\r\n\r\n      cache.delete({ key: Cache.PRODUCT_ITEM, id });\r\n    },\r\n  });\r\n}\r\n\r\nexport { useProducts, useProduct, useAddProductMutation, useChangeProductMutation, useRemoveProductMutation };\r\n","import { useMemo } from '@dark-engine/core';\r\n\r\nimport { useActiveRouteContext, useCurrentPathContext, checkContextValue } from '../context';\r\nimport { createPathname } from '../create-routes';\r\n\r\nexport type Match = {\r\n  path: string;\r\n  url: string;\r\n};\r\n\r\nfunction useMatch(): Match {\r\n  const activeRoute = useActiveRouteContext();\r\n  checkContextValue(activeRoute);\r\n  const path = useCurrentPathContext();\r\n  const {\r\n    location: { pathname },\r\n  } = activeRoute;\r\n  const url = useMemo(() => (path ? createPathname(pathname, path) : ''), [path, pathname]);\r\n  const value: Match = { path, url };\r\n\r\n  return value;\r\n}\r\n\r\nexport { useMatch };\r\n"],"names":["Header","slot","url","pathname","data","loading","error","isList","endsWith","urlToAdd","value","as","to","onClick","history","back","key","reverse","map","x","id","name","Cache","useResource","query","options","variables","cacheKey","extractId","onBefore","$scope","cache","cacheId","getNextResourceId","state","isFetching","isLoaded","record","read","createState","register","unregister","mounted","firstTime","scope","isMounted","isFirstTime","useMounted","update","$update","isServer","isHydrateZone","getIsHydrateZone","make","async","isRefetch","$variables","$$variables","$cacheId","setResource","write","err","String","valid","off","subscribe","type","canUpdate","res","getResource","mutate","defer","Error","result","refetch","useMutation","mutation","refetchQueries","onSuccess","args","forEach","invalidate","TIMEOUT","globalThis","window","sleep","ms","Promise","resolve","setTimeout","nextId","products","Array","fill","description","repeat","api","detectIsValidId","throwError","find","product","push","idx","findIndex","splice","Number","isNaN","useProducts","fetchProducts","PRODUCTS","console","log","useProduct","fetchProduct","PRODUCT_ITEM","useAddProductMutation","addProduct","optimistic","useChangeProductMutation","changeProduct","useRemoveProductMutation","removeProduct","delete","useMatch","activeRoute","path","location"],"sourceRoot":""}