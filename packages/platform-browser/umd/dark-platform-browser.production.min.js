!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("@dark-engine/core")):"function"==typeof define&&define.amd?define("DarkPlatformBrowser",["@dark-engine/core"],t):"object"==typeof exports?exports.DarkPlatformBrowser=t(require("@dark-engine/core")):e.DarkPlatformBrowser=t(e.DarkCore)}(self,(e=>(()=>{"use strict";var t={317:t=>{t.exports=e}},n={};function o(e){var r=n[e];if(void 0!==r)return r.exports;var a=n[e]={exports:{}};return t[e](a,a.exports,o),a.exports}o.d=(e,t)=>{for(var n in t)o.o(t,n)&&!o.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var r={};return(()=>{o.r(r),o.d(r,{createPortal:()=>n,createRoot:()=>F,render:()=>L,setTrackUpdate:()=>k,useStyle:()=>D});var e=o(317);const t=Symbol("portal");function n(e,n){if(!(n instanceof Element))throw new Error("[Dark]: createPortal receives only Element as container!");return a({[t]:n,slot:e})}const a=(0,e.createComponent)((n=>{var{slot:o}=n,r=function(e,t){var n={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(n[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(o=Object.getOwnPropertySymbols(e);r<o.length;r++)t.indexOf(o[r])<0&&Object.prototype.propertyIsEnumerable.call(e,o[r])&&(n[o[r]]=e[o[r]])}return n}(n,["slot"]);return(0,e.useMemo)((()=>r[t].innerHTML=""),[]),o}),{token:t}),i=n=>(0,e.detectIsComponentFactory)(n)&&n.token===t,l=e=>i(e)?e.props[t]:null;class s{constructor(e){this.type="",this.sourceEvent=null,this.target=null,this.propagation=!0,this.type=e.sourceEvent.type,this.sourceEvent=e.sourceEvent,this.target=e.target}stopPropagation(){this.propagation=!1,this.sourceEvent.stopPropagation()}preventDefault(){this.sourceEvent.preventDefault()}getPropagation(){return this.propagation}}function c(t){const{target:n,eventName:o,handler:r}=t,a=e.eventsStore.get(),i=a.get(o);if(i)i.set(n,r);else{const t=t=>{const n=a.get(o).get(t.target),r=t.target;let i=null;(0,e.detectIsFunction)(n)&&(i=new s({sourceEvent:t,target:r}),n(i)),(i?i.getPropagation():r.parentElement)&&r.parentElement.dispatchEvent(new t.constructor(t.type,t))};a.set(o,new WeakMap([[n,r]])),document.addEventListener(o,t,!0),e.eventsStore.addUnsubscriber((()=>document.removeEventListener(o,t,!0)))}}const u=e=>e.startsWith("on"),m=e=>e.slice(2,e.length).toLowerCase(),f={[e.ATTR_KEY]:!0,[e.ATTR_REF]:!0,void:!0};let p=new Map,d=null;function g(t,n){(0,e.detectIsFunction)(t)?t(n):(0,e.detectIsMutableRef)(t)&&(t.current=n)}const v={value:!0,checked:!0},E={value:!0},y={selected:!0},h={};function T(e){const{tagName:t,element:n,attrName:o,value:r}=e,a={input:()=>(v[o]&&(n[o]=r),v),textarea:()=>(E[o]&&(n[o]=r),E),option:()=>(y[o]&&(n[o]=r),y)};return a[t]?a[t]():h}function b(e){let t=e;for(;t;)if(t=t.parent,i(t.instance)&&(t.nativeElement=l(t.instance)),t.nativeElement)return t;return t}function k(e){d=e}const w={hight:[],normal:[],low1:[],low2:[]};let M=null,N=0,P=!1,S=null;class I{constructor(e){this.id=++I.nextTaskId,this.time=e.time,this.timeoutMs=e.timeoutMs,this.priority=e.priority,this.forceSync=e.forceSync,this.callback=e.callback}}function x(t){return!!t.length&&(S=t.shift(),S.callback(),S.forceSync?function(e){for(;e(););O(),S=null}(e.workLoop):(n=e.workLoop,M=n,P||(P=!0,C.postMessage(null))),!0);var n}function O(){Boolean(e.wipRootStore.get())||function(){const[t]=w.low2;return!!(t&&(0,e.getTime)()-t.time>t.timeoutMs)&&(x(w.low2),!0)}()||x(w.hight)||x(w.normal)||requestIdleCallback((()=>x(w.low1)||x(w.low2)))}I.nextTaskId=0;let R=null,C=null;R=new MessageChannel,C=R.port2,R.port1.onmessage=function(){if(M){N=(0,e.getTime)()+10;try{M()?C.postMessage(null):(S=null,P=!1,M=null,O())}catch(e){throw C.postMessage(null),e}}else P=!1},e.platform.createNativeElement=function(t){const n={[e.NodeType.TAG]:e=>{const t=e;var n;return n=t.name,Boolean({svg:!0,circle:!0,ellipse:!0,g:!0,text:!0,tspan:!0,textPath:!0,path:!0,polygon:!0,polyline:!0,line:!0,rect:!0,use:!0,image:!0,symbol:!0,defs:!0,linearGradient:!0,radialGradient:!0,stop:!0,clipPath:!0,pattern:!0,mask:!0,marker:!0}[n])?document.createElementNS("http://www.w3.org/2000/svg",t.name):document.createElement(t.name)},[e.NodeType.TEXT]:e=>{const t=e;return document.createTextNode(t.value)},[e.NodeType.COMMENT]:e=>{const t=e;return document.createComment(t.value)}};return n[t.type](t)},e.platform.requestAnimationFrame=requestAnimationFrame.bind(void 0),e.platform.scheduleCallback=function(t,n){const{priority:o=e.TaskPriority.NORMAL,timeoutMs:r=0,forceSync:a=!1}=n||{},i=new I({time:(0,e.getTime)(),timeoutMs:r,priority:o,forceSync:a,callback:t});({[e.TaskPriority.HIGH]:()=>w.hight.push(i),[e.TaskPriority.NORMAL]:()=>w.normal.push(i),[e.TaskPriority.LOW]:()=>i.timeoutMs>0?w.low2.push(i):w.low1.push(i)})[i.priority](),O()},e.platform.shouldYeildToHost=()=>(0,e.getTime)()>=N,e.platform.applyCommit=function(t){const n={[e.EffectTag.CREATE]:()=>{null!==t.nativeElement&&(d&&d(t.nativeElement),function(t){const n=b(t).nativeElement,o=n.childNodes;0===o.length||function(e,t){var n;let o=e;for(;o;){if((null===(n=null==o?void 0:o.parent)||void 0===n?void 0:n.nativeElement)===t)return o.idx;o=o.parent}return-1}(t,n)>o.length-1?(()=>{const{fragment:e}=p.get(n)||{fragment:document.createDocumentFragment(),callback:()=>{}};p.set(n,{fragment:e,callback:()=>{n.appendChild(e)}}),e.appendChild(t.nativeElement),t.markMountedToHost()})():(n.insertBefore(t.nativeElement,function(t,n){let o=null;return(0,e.walkFiber)({fiber:t,onLoop:({nextFiber:e,stop:t,resetIsDeepWalking:r})=>e.nativeElement&&e.nativeElement.parentElement===n?(o=e.nativeElement,t()):e.mountedToHost?void 0:r()}),o}(t,n)),t.markMountedToHost()),function(t,n){if(!(0,e.detectIsTagVirtualNode)(n))return;const o=Object.keys(n.attrs);for(const r of o){const o=n.attrs[r];r!==e.ATTR_REF?(0,e.detectIsFunction)(o)?u(r)&&c({target:t,handler:o,eventName:m(r)}):(0,e.detectIsUndefined)(o)||f[r]||!T({tagName:n.name,value:o,attrName:r,element:t})[r]&&t.setAttribute(r,o):g(o,t)}}(t.nativeElement,t.instance)}(t))},[e.EffectTag.UPDATE]:()=>{var n,o,r;null!==t.nativeElement&&(0,e.detectIsVirtualNode)(t.alternate.instance)&&(0,e.detectIsVirtualNode)(t.instance)&&(d&&d(t.nativeElement),n=t.nativeElement,o=t.alternate.instance,r=t.instance,(0,e.detectIsTextVirtualNode)(o)&&(0,e.detectIsTextVirtualNode)(r)&&o.value!==r.value?n.textContent=r.value:(0,e.detectIsTagVirtualNode)(o)&&(0,e.detectIsTagVirtualNode)(r)&&function(t,n,o){const r=new Set([...Object.keys(n.attrs),...Object.keys(o.attrs)]);for(const a of r){const r=n.attrs[a],i=o.attrs[a];a!==e.ATTR_REF?(0,e.detectIsUndefined)(i)?t.removeAttribute(a):(0,e.detectIsFunction)(r)?u(a)&&r!==i&&c({target:t,handler:i,eventName:m(a)}):f[a]||r===i||!T({tagName:o.name,value:i,attrName:a,element:t})[a]&&t.setAttribute(a,i):g(r,t)}}(n,o,r))},[e.EffectTag.DELETE]:()=>function(t){const n=b(t);(0,e.walkFiber)({fiber:t,onLoop:({nextFiber:e,isReturn:o,resetIsDeepWalking:r,stop:a})=>e===t.nextSibling||e===t.parent?a():!o&&e.nativeElement?(!i(e.instance)&&n.nativeElement.removeChild(e.nativeElement),r()):void 0})}(t),[e.EffectTag.SKIP]:()=>{}};n[t.effectTag]()},e.platform.finishCommitWork=function(){for(const{callback:e}of p.values())e();p=new Map},e.platform.detectIsPortal=i,e.platform.unmountPortal=function(e){const t=l(e.instance);t&&(t.innerHTML="")};const A=new Map;function L(t,n){if(!(n instanceof Element))throw new Error("[Dark]: render receives only Element as container!");const o=!(0,e.detectIsUndefined)(A.get(n));let r=null;o?r=A.get(n):(r=A.size,A.set(n,r),n.innerHTML=""),e.platform.scheduleCallback((()=>{e.rootStore.set(r);const a=e.currentRootStore.get(),i=new e.Fiber({nativeElement:n,instance:new e.TagVirtualNode({name:e.ROOT,children:(0,e.flatten)([t||(0,e.createEmptyVirtualNode)()])}),alternate:a,effectTag:o?e.EffectTag.UPDATE:e.EffectTag.CREATE});a&&(a.alternate=null),e.fiberMountStore.reset(),e.wipRootStore.set(i),e.nextUnitOfWorkStore.set(i)}),{priority:e.TaskPriority.NORMAL,forceSync:e.isLayoutEffectsZone.get()})}function F(t){return{render:e=>L(e,t),unmount:()=>{const n=A.get(t);(0,e.unmountRoot)(n,(()=>{A.delete(t),t.innerHTML=""}))}}}function j(t,...n){return(0,e.useMemo)((()=>t.map(((t,o)=>t+((0,e.detectIsUndefined)(n[o])?"":n[o]))).join("").replace(/;\s*/gm,";").replace(/:\s*/gm,":").trim()),[t,...n])}function D(e){return e(j)}})(),r})()));
//# sourceMappingURL=dark-platform-browser.production.min.js.map